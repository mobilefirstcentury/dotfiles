---- Coffee Script ----
======================

Installation
------------
    npm install -g coffee-script # latest stable
    npm install -g jashkenas/coffeescript # latest master branch from coffee script repo


Usage
-----

  $ coffee  

  -b, --bare         compile without a top-level function wrapper
  -c, --compile      compile to JavaScript and save as .js files
  -e, --eval         pass a string from the command line as input
  -h, --help         display this help message
  -i, --interactive  run an interactive CoffeeScript REPL
  -j, --join         concatenate the source CoffeeScript before compiling
  -m, --map          generate source map and save as .js.map files
  -n, --nodes        print out the parse tree that the parser produces
      --nodejs       pass options directly to the "node" binary
      --no-header    suppress the "Generated by" header
  -o, --output       set the output directory for compiled JavaScript
  -p, --print        print out the compiled JavaScript
  -r, --require      require the given module before eval or REPL
  -s, --stdio        listen for and compile scripts over stdio
  -l, --literate     treat stdio as literate style coffee-script
  -t, --tokens       print out the tokens that the lexer/rewriter produce
  -v, --version      display the version number
  -w, --watch        watch scripts for changes and rerun commands


Functions
----------
  + fonction call : `→` means is converted in javascript code
  
    `console.log sys.inspect object` → `console.log(sys.inspect(object));`

  + definition

    ```
    square = (x) -> x * x
    cube   = (x) -> square(x) * x
    ```
  + arguments default values

    ```
    fill = (container, liquid = "coffee") ->
      "Filling the #{container} with #{liquid}..."
    ```
  + Coffee Scripts returns everything as often as possible (better for readability and usability) 
    ```
    # In examples below we don't need to explicitely return the strings
    grade = (student) ->
      if student.excellentWork
        "A+"
      else if student.okayStuff
        if student.triedHard then "B" else "B-"
      else
        "C"

    eldest = if 24 > 21 then "Liz" else "Ike"
    ```

Objects and Arrays
------------------
    ```
    song = ["do", "re", "mi", "fa", "so"]

    singers = {Jagger: "Rock", Elvis: "Roll"}

    bitlist = [
      1, 0, 1
      0, 0, 1
      1, 1, 0
    ]

    kids =
      brother:
        name: "Max"
        age:  11
      sister:
        name: "Ida"
        age:  9

    ages = max: 10, ida: 9, tim: 11

    # note: unlike javascript, reserved words can bu used as object keys normally
    $('.account').attr class: 'active'
    ```

Lexical Scoping and Variable Safety
----------------------------------
  - All of the variable declarations have been pushed up to the top of the closest scope.
  - Javascript generated code is protected in a `(function(){ ... })();` safety wrapper:
    + global scope can't be polluted
    + to create global variable, one has to attach them to **window** or **exports** objects:
    ```
    root = exports ? this
    root.foo = -> 'Hello World'
    ```


If, Else, Unless, and Conditional Assignment
--------------------------------------------

    ```
    mood = greatlyImproved if singing
    mood = joyfull unless today is monday

    if happy and knowsIt
      clapsHands()
      chaChaCha()
    else
      showIt()

    date = if friday then sue else jill

    ```


Splats...
---------

    ```
    gold = silver = rest = "unknown"

    awardMedals = (first, second, others...) ->
      gold   = first
      silver = second
      rest   = others

    contenders = [
      "Michael Phelps"
      "Liu Xiang"
      "Yao Ming"
      "Allyson Felix"
      "Shawn Johnson"
      "Roman Sebrle"
      "Guo Jingjing"
      "Tyson Gay"
      "Asafa Powell"
      "Usain Bolt"
    ]

    awardMedals contenders...

    alert "Gold: " + gold
    alert "Silver: " + silver
    alert "The Field: " + rest
    ```

Loops and Comprehensions
------------------------

### general notes
  - Coffee Script used smart loops ('arrays conprehensions'): `num for num in number-array`
  - **note** smart loops should replace most use cases of **each**/**forEach**, **map**, or **select**/**filter**, ...
  - unlike for loops, coffee script smart loops  are expressions, and can be returned and assigned.
  - if assigned to a variable, all iteration steps results are collected in an array (also true for while loops -- see below) 
  ```
  # all global properties in a array
  globals = (name for name of window)[
  # The first ten global properties only.
  globals = (name for name of window)[0...10] 
  ```

### normal iterations
    ```
    eat food for food in ['toast', 'cheese', 'wine']

    courses = ['greens', 'caviar', 'truffles', 'roast', 'cake']
    echo "choice #{i+1}: #{dish}" for dish, i in courses

    foods = ['broccoli', 'spinach', 'chocolate']
    eat food for food in foods when food isnt 'chocolate'

    shortNames = (name for name in list when name.length < 5)

    countdown = (num for num in [10..1])

    evens = (x for x in [0..10] by 2) 

    echo "this line is repeated 10 times" for [0...10]

    ```
### iteration over keys and values

    ```
    yearsOld = max: 10, ida: 9, tim: 11

    ages = for child, age of yearsOld
      "#{child} is #{age}"
    ```
### iteration over non inherited keys 
    `for own key, value of object`

### while loop

    ```
    buy()  while supply > demand
    buy()  until demand >= supply
    
    num = 6
    lyrics = while num -= 1
      "#{num} little monkeys, jumping on the bed.
        One fell out and bumped his head."


    # loop is a shortcut for `while true`
    loop 
      climb-one-step-to-the-sky()

    ```

### variable discrimination in callbacks embedded in loops
    + using callbacks in loops is REALLY UNINTUITIVE: callbacks access outside variables "by reference" (sort of) not "by value" 
    + so one ends frequently with all callback sharing last iterated value of the used variable: the following code bugs as filename is always `list[0]`
    ```
    for (i = 0, len = 10; i < len; i++) {
      filename = list[i];
      fs.readFile(filename, function(err, contents) {
        return compile(filename, contents.toString());
      });
    }
    ```

    + the classic work around is to wrap the code with a function that's immediatly called and given used variables as arguments (arguments are passed by value)
    + CoffeeScript provides the `do` keyword for just that ...

    ```
    for filename in list
      do (filename) ->
        fs.readFile filename, (err, contents) ->
          compile filename, contents.toString()
    ```


Array Slicing and Splicing with Ranges
--------------------------------------

### slicing

    ```
    numbers = [0...10]  # means [0,1,2,3,4,5,6,7,8,9] as `...` excludes last element
    start   = numbers[0..2] # [ 0, 1, 2 ]
    middle  = numbers[3...-2]  # [ 3, 4, 5, 6, 7 ]
    end     = numbers[-2..] # [ 8, 9 ]
    copy    = numbers[..]  # [0,1,2,3,4,5,6,7,8,9]
    ```

### array assignement (splicing) 
  **note** JavaScript strings are immutable, and can't be spliced.
    numbers = [0,...10]
    numbers[3..6] = [-3, -4, -5, -6]





Operators and Aliases
---------------------
### Coffee Script / Javascript equivalences

 CoffeeScript  | JavaScript
---            | --
==             | ===
!=             | !==
is             | ===
isnt           | !==
not            | !
and            | &&
or             | ||
true, yes, on  | true
false, no, off | false
@, this        | this
of             | in (present in object keys)
in             | no JS equivalent (present in array values)
a ** b         | Math.pow(a, b)
a // b         | Math.floor(a / b)
a %% b         | (a % b + b) % b
then           | Instead of a newline or semicolon, `then` can be used to separate conditions from expressions, in **while**, **if**/**else**, and **switch**/**when** 
@property      | this.property

### Example idioms

    ```
    launch() if ignition is on
    volume = 10 if band isnt SpinalTap
    letTheWildRumpusBegin() unless answer is no
    winner = yes if pick in [47, 92, 13]
    print inspect "My name is #{@name}"
    ```

?, The Existential Operator and Accessor
--------------------------------------

** note **
  Operator `?` returns true unless a variable is **null** or **undefined**

    ```
    # test for the existence of mind
    solipsism = true if mind?

    # binary ? returns 'yeti' if it exists and 'bear' otherwise
    footprints = yeti ? "bear"

    # provide default value (better than javascript classic |=)
    # equivalent to speed = speed ? 15 
    # [TODO] but speed HAS to be already declared but i don't know how to declare in CoffeeScript
    speed ?= 15

    # call a function safely: nothing is executed but no error is thrown...
    noSuchFunction?()

    # if lottery has a drawWinner method and if the draw Winner has an adress then get the zip code 
    zip = lottery.drawWinner?().address?.zipcode
    ```


Classes, Inheritance, and Super
-------------------------------

### Simple Class delcaration and inheritance example
    class Animal
      constructor: (@name) ->

      move: (meters) ->
        alert @name + " moved #{meters}m."

    class Snake extends Animal
      move: ->
        alert "Slithering..."
        super 5

    class Horse extends Animal
      move: ->
        alert "Galloping..."
        super 45

    sam = new Snake "Sammy the Python"
    tom = new Horse "Tommy the Palomino"

    sam.move()
    tom.move()

### extends, :: and super operators
  - extends can be used with any couple of 'à la javascript' constructors functions 
  - `::` operator gives quick access to an object's prototype.
  - `super` is converted into a call against the immediate ancestor's method of the same name.

    ```
    String::dasherize = ->
      this.replace /_/g, "-"

    String.prototype.dasherize = function() {
      return this.replace(/_/g, "-");
    };
    ```

Destructuring Assignment
------------------------

### variable swapping
    ```
    theBait   = 1000
    theSwitch = 0
    [theBait, theSwitch] = [theSwitch, theBait]
    ```

### Functions returning multiples values 

    ```
    weatherReport = (location) ->
      # Make an Ajax request to fetch the weather...
      [location, 72, "Mostly Sunny"]

    [city, temp, forecast] = weatherReport "Berkeley, CA"
    ```


### nested properties pull out

    ```
    # this translates to `spawn = require('child_process').spawn`
    {spawn} = require "child_process" 
    ```

    ```
    futurists =
      sculptor: "Umberto Boccioni"
      painter:  "Vladimir Burliuk"
      poet:
        name:   "F.T. Marinetti"
        address: [
          "Via Roma 42R"
          "Bellagio, Italy 22021"
        ]

    {poet: {name, address: [street, city]}} = futurists

    ```
### With splats, destructuring on steroids

   ```
   [first-letter, middle..., last-letter] = "impossible".split("")
   [first-word, ..., last-word] = "Every literary critic believes he will outwit history and have the last word".split " "
    ```

### Destructured Options for Class Constructors 
** note ** Best practice for class definition

    ```
    class Person
      constructor: (options) ->
        {@name, @age, @height = 'average'} = options

    tim = new Person name: 'Tim', age: 4
    ```


Bound Functions, Generator Functions
------------------------------------

  - In JavaScript, to preserve `this` reference in callbacks one has to write weird boilerplate code. 
  - Coffee Scripts used the fat arrow operator to attach a callback to specific `this` object

    ```
    # @customer and @cart are what we expect in the 'fat arrow-ed' callback
    # without the fat arrow `@customer` would have referred to the undefined "customer" property of the DOM element and would have raised an exception.
    Account = (customer, cart) ->
      @customer = customer
      @cart = cart

      $('.shopping_cart').on 'click', (event) =>
        @customer.purchase @cart
    ```


Generators
---------

    ```
    perfectSquares = ->
      num = 0
      loop
        num += 1
        yield num * num
      return

    console.log perfectSquares.next().value
    console.log perfectSquares.next().value
    ```


Switch/When/Else
-----------------

    # For improved readability there's no need for 'break' operator in switch statement
    ```
    switch day
      when "Mon" then go work
      when "Tue" then go relax
      when "Thu" then go iceFishing
      when "Fri", "Sat"
        if day is bingoDay
          go bingo
          go dancing
      when "Sun" then go church
      else go work
      ```
    # We can have a much cleaner if/else chain with switch operator
    ```
    score = 76
    grade = switch
      when score < 60 then 'F'
      when score < 70 then 'D'
      when score < 80 then 'C'
      when score < 90 then 'B'
      else 'A'
    ```

Try/Catch/Finally
=================


    ```
    try
      allHellBreaksLoose()
      catsAndDogsLivingTogether()
    catch error
      print error
    finally
      cleanUp()
    ```

Chained Comparisons
-------------------

    ```
    cholesterol = 127
    healthy = 200 > cholesterol > 60
    ```


String Interpolation, Block Strings, and Block Comments
-------------------------------------------------------

### Ruby-style string interpolation

  - double quoted strings allow for interpolated values
  - single quoted strings are literals

    ```
    author = "Wittgenstein"
    quote  = "A picture is a fact. -- #{ author }"

    sentence = "#{ 22 / 7 } is a decent approximation of π"
    ```

### multi-line strings 

    # front indentations are ignored
    mobyDick = "Call me Ishmael. Some years ago,
      never mind how long precisely, having little
      or no money in my purse, and nothing particular
      to interest me on shore, I thought I would sail
      about a little and see the watery part of the
      world..."

### block strings (with smart indentation)

    # first identation is preserved to have code aligned
    ```
    html = """
           <strong>
             cup of coffeescript
           </strong>
           """
    ```
    tranlslates in ...

    ```
    html = "<strong>\n  cup of coffeescript\n</strong>";
    ```


Javascript comments generation
-------------------------------

    # this will generate comments in the compiled javascript code
    ```
    ###
    SkinnyMochaHalfCaffScript Compiler v1.0
    Released under the MIT License
    ###
    ```


Block Regular Expressions
-------------------------
  - block regex are extended regular expressions that ignore internal whitespace and can contain comments and interpolation. 
  - modeled after Perl's `/x` modifier, CoffeeScript's block regexes are delimited by `///` 

    ```
    OPERATOR = /// ^ (
      ?: [-=]>             # function
       | [-+*/%<>&|^!?=]=  # compound assign / compare
       | >>>=?             # zero-fill right shift
       | ([-+:])\1         # doubles
       | ([&|<>])\2=?      # logic / shift
       | \?\.              # soak access
       | \.{2,3}           # range or splat
    ) ///
    ```


Cake, and Cakefiles
-------------------
  **notes** [shortcake](https://github.com/zeekay/shortcake) is a much more powerfull alternative.
  
  - A very basic build system for coffee Script
  - to execute tasks:
    $ cake -o "myDir" setup

    # [TODO] not sure this code is correct ...
    ```
    fs = require 'fs'
    dir = ""

    option '-o', '--output [DIR]', 'output directory'

    task 'setup', 'setup da thing', (options) ->
      dir  = options.output or 'lib'
      setup-details = ...
      fs.writeFile "#{dir}/setup-file.js", setup-details

    task 'run', 'run da thing', (options) ->
      invoke 'setup'
      # do something with `dir` and setup file ...
    ```

